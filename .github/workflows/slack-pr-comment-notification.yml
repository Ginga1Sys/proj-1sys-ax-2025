name: Slack PR Comment Notification

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  commit_comment:
    types: [created]
  discussion_comment:
    types: [created]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    # ÂØæË±°„Ç§„Éô„É≥„Éà„ÇíÊòéÁ§∫ÔºàPR„ÉªIssue„Éª„Ç≥„Éü„ÉÉ„Éà„Éª„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„ÅÆ„Ç≥„É°„É≥„ÉàÔºâ
    if: >
      github.event_name == 'issue_comment' ||
      github.event_name == 'pull_request_review_comment' ||
      github.event_name == 'pull_request_review' ||
      github.event_name == 'commit_comment' ||
      github.event_name == 'discussion_comment'

    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # „Ç§„Éô„É≥„Éà„Çø„Ç§„Éó„Å´Âøú„Åò„ÅüÊÉÖÂ†±„ÇíÂèñÂæóÔºàPR/Issue/Commit/DiscussionÔºâ
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            COMMENTER="${{ github.event.comment.user.login }}"
            TARGET_URL="${{ github.event.issue.html_url }}"
            TITLE="${{ github.event.issue.title }}"
            NUMBER="${{ github.event.issue.number }}"
            COMMENT_TYPE="Issue„Ç≥„É°„É≥„Éà"
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            COMMENTER="${{ github.event.comment.user.login }}"
            TARGET_URL="${{ github.event.pull_request.html_url }}"
            TITLE="${{ github.event.pull_request.title }}"
            NUMBER="${{ github.event.pull_request.number }}"
            COMMENT_TYPE="„É¨„Éì„É•„Éº„Ç≥„É°„É≥„Éà"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            COMMENT_BODY="${{ github.event.review.body }}"
            COMMENT_URL="${{ github.event.review.html_url }}"
            COMMENTER="${{ github.event.review.user.login }}"
            TARGET_URL="${{ github.event.pull_request.html_url }}"
            TITLE="${{ github.event.pull_request.title }}"
            NUMBER="${{ github.event.pull_request.number }}"
            COMMENT_TYPE="„É¨„Éì„É•„Éº"
          elif [ "${{ github.event_name }}" = "commit_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            COMMENTER="${{ github.event.comment.user.login }}"
            TARGET_URL="${{ github.event.comment.html_url }}"
            TITLE="Commit ${GITHUB_SHA:0:7}"
            NUMBER=""
            COMMENT_TYPE="„Ç≥„Éü„ÉÉ„Éà„Ç≥„É°„É≥„Éà"
          elif [ "${{ github.event_name }}" = "discussion_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            COMMENTER="${{ github.event.comment.user.login }}"
            TARGET_URL="${{ github.event.discussion.html_url }}"
            TITLE="${{ github.event.discussion.title }}"
            NUMBER="${{ github.event.discussion.number }}"
            COMMENT_TYPE="„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Ç≥„É°„É≥„Éà"
          fi

          # „Ç≥„É°„É≥„ÉàÊú¨Êñá„Éó„É¨„Éì„É•„ÉºÊï¥ÂΩ¢
          if [ -z "${COMMENT_BODY}" ]; then
            COMMENT_PREVIEW="(Êú¨Êñá„Å™„Åó)"
          elif [ ${#COMMENT_BODY} -gt 100 ]; then
            COMMENT_PREVIEW="${COMMENT_BODY:0:100}..."
          else
            COMMENT_PREVIEW="${COMMENT_BODY}"
          fi

          # Ë°®Á§∫Áî®„Çø„Ç§„Éà„É´ÔºàÁï™Âè∑„Åå„ÅÇ„Çå„Å∞‰ªò‰∏éÔºâ ‚Äî YAMLÂÜÖ„ÅßË§áÈõë„Å™Â±ïÈñã„ÇíÈÅø„Åë„Çã
          if [ -n "${NUMBER}" ]; then
            DISPLAY_TITLE="#${NUMBER} ${TITLE}"
          else
            DISPLAY_TITLE="${TITLE}"
          fi

          # SlackÈÄöÁü•„ÅÆ„Éö„Ç§„É≠„Éº„Éâ„Çí‰ΩúÊàê
          PAYLOAD=$(cat <<EOF
          {
            "text": "„Ç≥„É°„É≥„Éà„ÅåÊäïÁ®ø„Åï„Çå„Åæ„Åó„Åü",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üí¨ Êñ∞„Åó„ÅÑ${COMMENT_TYPE}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ÂØæË±°:*\\n<${TARGET_URL}|${DISPLAY_TITLE}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ÊäïÁ®øËÄÖ:*\\n${COMMENTER}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*„Ç≥„É°„É≥„Éà:*\\n${COMMENT_PREVIEW}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "„Ç≥„É°„É≥„Éà„ÇíË¶ã„Çã"
                    },
                    "url": "${COMMENT_URL}"
                  }
                ]
              }
            ]
          }
          EOF
          )

          # Slack Webhook„Å´ÈÄÅ‰ø°
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
