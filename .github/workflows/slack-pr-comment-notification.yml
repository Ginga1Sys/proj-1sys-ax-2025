name: Slack PR Comment Notification

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    # PRã«é–¢é€£ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
    if: github.event.issue.pull_request || github.event.pull_request

    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸæƒ…å ±ã‚’å–å¾—
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            COMMENTER="${{ github.event.comment.user.login }}"
            PR_TITLE="${{ github.event.issue.title }}"
            PR_NUMBER="${{ github.event.issue.number }}"
            COMMENT_TYPE="PRã‚³ãƒ¡ãƒ³ãƒˆ"
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            COMMENTER="${{ github.event.comment.user.login }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            COMMENT_TYPE="ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            COMMENT_BODY="${{ github.event.review.body }}"
            COMMENT_URL="${{ github.event.review.html_url }}"
            COMMENTER="${{ github.event.review.user.login }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            COMMENT_TYPE="ãƒ¬ãƒ“ãƒ¥ãƒ¼"
          fi

          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’æœ€åˆã®100æ–‡å­—ã«åˆ¶é™ï¼ˆé•·ã„å ´åˆã¯çœç•¥è¨˜å·ã‚’è¿½åŠ ï¼‰
          if [ ${#COMMENT_BODY} -gt 100 ]; then
            COMMENT_PREVIEW="${COMMENT_BODY:0:100}..."
          else
            COMMENT_PREVIEW="$COMMENT_BODY"
          fi

          # Slacké€šçŸ¥ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
          PAYLOAD=$(cat <<EOF
          {
            "text": "PR ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ğŸ’¬ æ–°ã—ã„${COMMENT_TYPE}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*PR:*\n<${{ github.event.pull_request.html_url || github.event.issue.html_url }}|#${PR_NUMBER} ${PR_TITLE}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*æŠ•ç¨¿è€…:*\n${COMMENTER}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ã‚³ãƒ¡ãƒ³ãƒˆ:*\n${COMMENT_PREVIEW}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹"
                    },
                    "url": "${COMMENT_URL}"
                  }
                ]
              }
            ]
          }
          EOF
          )

          # Slack Webhookã«é€ä¿¡
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
