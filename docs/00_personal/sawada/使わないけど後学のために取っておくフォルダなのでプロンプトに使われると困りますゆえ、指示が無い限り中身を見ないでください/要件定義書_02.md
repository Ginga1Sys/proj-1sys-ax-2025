```markdown
# 要件定義書

**リポジトリ**: proj-1sys-ax-2025

**作成日**: 2025-11-27

## 1. ドキュメント目的
本書は、社内向けナレッジ共有プラットフォーム（以下「本システム」）の要件を整理する。既存のユーザーストーリー、機能要件、非機能要件を統合し、曖昧な点は合理的に具体化して実装/受け入れ判定可能な仕様にする。

## 2. 範囲（Scope）
- 対象: 社内ユーザー向けの投稿・検索・閲覧・インタラクション機能、および管理者による承認・権限管理。
- 非対象: 外部公開サイト（初期フェーズ）、高度な分析ダッシュボード（将来対応）。

## 3. 前提・仮定（Concrete assumptions）
- 社内メールドメインは `@yourcompany.co.jp` とする（導入時に実際のドメインに置換）。
- 初期ユーザー数は数百人を想定し、ピーク同時接続は100セッションを想定する。
- データ保管はクラウド（例: AWS/GCP/Azure）を想定するが、オンプレミスでも運用可能なアーキテクチャを念頭に置く。

## 4. 用語定義
- 投稿: ユーザーが作成する記事・ノウハウなどのエントリ。
- 投稿者: 投稿を作成するユーザー。
- 管理者: 投稿承認・権限管理を行うユーザー。

## 5. ユーザーストーリー（要約）
- 認証: 社内ドメインでの登録/ログイン、パスワードリセット。
- 投稿: テキスト・画像・リンク・ファイル添付、タグ付け、ドラフト、編集履歴。
- 承認ワークフロー: 管理者による承認/却下と履歴保存。
- 検索/フィルタ: タイトル/本文/タグ/投稿者名で検索、関連度/日付ソート。
- インタラクション: いいね・コメント・通報。
- 権限管理: ロール（一般、編集者、管理者）。

## 6. 機能要件（Functional Requirements）

### FR-001: ユーザー認証（優先度: 高）
- 概要: 社内ドメイン `@yourcompany.co.jp` のメールで登録/ログインを行う。
- 詳細/受け入れ基準:
  - 新規登録は社内ドメインのメールアドレスのみ受け付ける（ドメイン検証）。
  - メール確認リンクを送付し、クリックでアカウント有効化とする。運用要件により管理者承認フローを追加できる（管理画面で切替可能）。
  - パスワードリセットはメールベースで行う。
  - パスワードは `bcrypt`（コストファクタ12想定）でハッシュ化して保存する。
  - 認証系APIはTLS（TLS1.2以上）で保護する。

### FR-002: 投稿作成・編集（優先度: 高）
- 概要: 投稿にテキスト、画像、リンク、ファイル添付を許可し、タグ/カテゴリーを付与できる。
- 詳細/受け入れ基準:
  - 投稿作成UIを持ち、リッチテキスト（マークダウンまたはWYSIWYG）をサポートする。
  - 画像は最大ファイルサイズ 10MB、添付ファイルは最大 50MB とする（運用で変更可能）。
  - タグの作成・選択が可能。タグは管理者がブラックリスト管理できる。
  - 編集履歴を保持（バージョン管理）。各編集は誰がいつ行ったか記録すること。
  - ドラフト保存機能を提供する（ブラウザ自動保存 + 明示的ドラフト保存）。

### FR-003: 投稿承認ワークフロー（優先度: 中）
- 概要: 管理者が投稿の承認/却下を行える。
- 詳細/受け入れ基準:
  - 新規投稿(または編集投稿)を「下書き」「公開申請」「公開」のステータスで管理する。公開申請時に管理者の承認が必要。
  - 承認/却下の履歴とコメントを保存する。

### FR-004: 検索・フィルタ（優先度: 高）
- 概要: 投稿をキーワード・タグ・投稿者名で検索・絞り込む。
- 詳細/受け入れ基準:
  - フルテキスト検索（タイトル・本文・タグ・コメント）を提供する。初期はトークンベースの検索（例: Elasticsearch/CloudSearch）を想定。
  - 検索結果は関連度順、または日付順でソート可能。
  - 絞り込み（タグ、投稿者、カテゴリー、公開日範囲）を提供する。

### FR-005: インタラクション（優先度: 高）
- 概要: いいね・コメント・通報機能。
- 詳細/受け入れ基準:
  - 投稿に対する「いいね」を記録（ユーザー毎に1回）。件数を高速に集計表示できる。
  - コメントは返信機能を含むスレッド形式をサポート。モデレーション機能（削除/非表示）を管理者に提供する。
  - 不適切報告（通報）を受け付け、対応履歴を保存する。

### FR-006: 権限管理（優先度: 中）
- 概要: ロールベースの権限管理（一般、編集者、管理者）。
- 詳細/受け入れ基準:
  - ロールは管理画面で割当可能。各ロールの権限一覧を定義する（例: 投稿公開権限、承認権限、ユーザー管理権限）。

## 7. 非機能要件（NFR）

### NFR-001: セキュリティ（優先度: 高）
- 受け入れ基準（具体値）:
  - 全通信は TLS1.2 以上で暗号化する。
  - パスワードは `bcrypt`（コスト12）によりハッシュ化する。
  - 重要操作（ユーザー作成/権限変更/コンテンツ削除）は監査ログに記録し、ログは 365 日保持する。
  - 脆弱性対策: OWASP Top10 を参照した基本対策を実装する（入力検証、CSRF、XSS 対策等）。

### NFR-002: パフォーマンス・可用性（優先度: 中）
- 受け入れ基準（具体値）:
  - 平均応答時間（ページロード）は2秒以内を目標とする（ベンチ環境で測定）。
  - ピーク同時接続100セッションでの安定稼働を目標とする。将来的に水平スケール可能なアーキテクチャを採用する。
  - 可用性目標: 99.5%/月（初期フェーズ）。

### NFR-003: 拡張性（優先度: 中）
- 受け入れ基準:
  - API ファースト設計で内部・将来の外部連携を容易にする。
  - モジュール化されたコード構成とドキュメントを維持する。

### NFR-004: 運用・保守（優先度: 中）
- 受け入れ基準（具体値）:
  - データバックアップは日次で実施し、バックアップは最低30日間保持する。
  - 監視: 主要サービス（認証、検索、DB、ストレージ）を監視し、閾値超過でアラートを送信する。
  - 障害対応手順（復旧手順）を整備する。

## 8. データ保存方針・Retention
- 投稿データ: 永続保存（削除は管理者操作で実施）。
- ログ: 監査ログは365日保持、アクセスログは90日保持（運用で延長可能）。
- バックアップ: 日次フル/差分戦略、30日保持。

## 9. API / 実装に関する具体化（例）
- 認証API: `POST /api/v1/auth/register`, `POST /api/v1/auth/login`, `POST /api/v1/auth/reset`。
- 投稿API: `GET /api/v1/posts`, `POST /api/v1/posts`, `PUT /api/v1/posts/{id}`, `DELETE /api/v1/posts/{id}`。
- 検索API: `GET /api/v1/search?q={query}&tag={tag}&sort={relevance|date}`。

（上記は初期設計例。実装前に詳細 API 仕様書を作成すること）

## 10. 受け入れテストのサマリ
- 各機能の受け入れ基準に沿った E2E テストケースを作成する。
  - 認証: 新規登録→メール確認→ログイン→パスワードリセットのシナリオ。
  - 投稿: 作成→編集→履歴確認→公開申請→承認の一連。
  - 検索: 複数条件での絞り込み・ソートの検証。レスポンス時間測定。

## 11. 優先度とリリース計画（提案）
- MVP（リリース1）: FR-001（認証）、FR-002（投稿基本）、FR-004（検索基本）、FR-005（いいね/コメント基本）、NFR-001（基本的なセキュリティ）。
- リリース2: FR-003（承認ワークフロー）、FR-006（権限管理の拡張）、NFR-002/003（パフォーマンス強化、拡張機能）。

## 12. リスクと対策
- リスク: 検索性能が期待を下回る可能性→対策: 外部検索エンジン（Elasticsearch など）導入を早期に検討。
- リスク: 管理者承認運用がボトルネック→対策: 自動承認ルール・権限付与の見直し。

## 13. 次のアクション（推奨）
1. 本書のレビュー（関係者による要件確認）。
2. API 仕様（エンドポイント、データモデル）を作成。
3. 初期アーキテクチャ設計（インフラ見積り、選定）。
4. 優先度に基づく見積りとスプリント計画の作成。

---
※ 本書は `ユーザーストーリー_顧客要求事項.md`, `機能要件.md`, `非機能要件.md` を基に作成しています。曖昧な項目（ドメイン名、SLA、ログ保持期間、ファイルサイズ上限など）は初期運用に合わせて合理的に具体化しました。必要があれば値は運用方針で変更してください。

```